<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Front Gate Controller</title>
		<style>
			:root {
				--bg-start: #0a0611;
				--bg-mid: #0f0814;
				--bg-end: #0c0512;
				--card-bg: #0b0712;
				--text: #ffffff;
				--muted: #a79ed0;
				--accent: #a47edc;
				--accent-hover: #d0bfff;
				--border: #3a2f50;
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			body {
				min-height: 100vh;
				display: flex;
				justify-content: center;
				align-items: center;
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco,
					"Roboto Mono", monospace;
				color: var(--text);
				background: linear-gradient(
					135deg,
					var(--bg-start),
					var(--bg-mid),
					var(--bg-end)
				);
			}

			.card {
				width: min(700px, 90vw);
				background: var(--card-bg);
				padding: 28px;
				border-radius: 10px;
				border: 1px solid var(--border);
			}

			h1 {
				font-size: 22px;
				color: var(--accent);
				margin-bottom: 10px;
			}

			p.lead {
				color: var(--text);
				font-size: 13px;
				margin-bottom: 16px;
			}

			form {
				display: flex;
				gap: 12px;
				align-items: center;
			}

			.col {
				flex: 1;
			}

			label.small {
				display: block;
				font-size: 12px;
				color: var(--muted);
				margin-bottom: 6px;
			}

			input[type="password"] {
				width: 100%;
				padding: 10px;
				border-radius: 6px;
				border: 1px solid var(--border);
				background: rgba(255, 255, 255, 0.03);
				color: var(--text);
				outline: none;
				font-family: inherit;
				font-size: 14px;
			}

			.button-wrapper {
				display: flex;
				align-items: center; /* vertically center the button relative to input */
			}

			button {
				background: none;
				border: none;
				font-weight: 700;
				color: var(--accent);
				font-family: inherit;
				font-size: 14px;
				cursor: pointer;
				padding: 0;
				border-bottom: 1px solid transparent;
				transition: border-color 0.2s;
			}

			button:hover {
				border-color: var(--accent-hover);
			}

			.status {
				margin-top: 14px;
				color: var(--muted);
				font-size: 13px;
				display: flex;
				gap: 10px;
				align-items: center;
			}

			.connected-dot {
				width: 10px;
				height: 10px;
				border-radius: 50%;
			}

			.connected {
				background: var(--accent);
			}
			.disconnected {
				background: #4b4963;
			}

			pre.output {
				margin-top: 12px;
				padding: 12px;
				border-radius: 6px;
				background: #100712;
				color: var(--text);
				font-family: inherit;
				font-size: 13px;
				border: 1px solid var(--border);
			}

			@media (max-width: 520px) {
				form {
					flex-direction: column;
					align-items: stretch;
				}
				.button-wrapper {
					width: 100%;
				}
				button {
					width: 100%;
					border-bottom: none;
				}
			}
		</style>
	</head>
	<body>
		<div class="card">
			<h1>Front Gate Controller</h1>
			<p class="lead">
				Enter password and press <strong>Send Command</strong>. Sends
				command to the connected device.
			</p>

			<form id="form" autocomplete="on">
				<div class="col">
					<label class="small">Password</label>
					<input
						id="pw"
						name="password"
						type="password"
						placeholder="Type password..."
						autocomplete="current-password"
						required
					/>
				</div>
				<div class="button-wrapper">
					<button type="submit">Send Command</button>
				</div>
			</form>

			<div class="status">
				<span id="conn" class="connected-dot disconnected"></span>
				<span id="status-text"></span>
				<span id="result"></span>
			</div>

			<pre class="output" id="output">Output will appear here...</pre>
		</div>

		<script>
			const $ = (id) => document.getElementById(id);
			const result = $("result");
			const output = $("output");
			const conn = $("conn");
			const statusText = $("status-text");

			async function updateStatus() {
				try {
					const resp = await fetch("/gate/status");
					if (!resp.ok) throw new Error("Status fetch failed");
					const data = await resp.json();
					if (data.connected) {
						conn.className = "connected-dot connected";
						statusText.textContent =
							"Connected to " + (data.device || "device");
					} else {
						conn.className = "connected-dot disconnected";
						statusText.textContent = "Flipper not connected";
					}
				} catch {
					conn.className = "connected-dot disconnected";
					statusText.textContent = "Flipper not connected";
				}
			}

			// Run once on load
			updateStatus();

			$("form").addEventListener("submit", async (e) => {
				e.preventDefault();
				const pw = $("pw").value || "";
				result.textContent = "Sending...";
				try {
					const resp = await fetch("/gate/send", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ password: pw }),
					});
					const j = await resp.json();
					if (j.ok) {
						result.textContent = "Command sent";
						output.textContent = j.response || "(no response)";
					} else {
						result.textContent = "Error";
						output.textContent = j.error || "Error";
					}

					await updateStatus(); // refresh connected dot
				} catch (err) {
					result.textContent = "Client error";
					output.textContent = "Client error: " + err.message;
				}
			});
		</script>
	</body>
</html>
